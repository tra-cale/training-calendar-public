<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¹´é–“ã‚µãƒãƒªãƒ¼ - å¥åº·ç®¡ç†ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
* { 
  margin: 0; 
  padding: 0; 
  box-sizing: border-box; 
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #FFF9C4 0%, #FFECB3 50%, #FFE082 100%);
  min-height: 100vh;
  padding: 20px;
  color: #212121;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  background: #FAFAFA;
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.15);
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.header {
  text-align: center;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 3px solid #FFD54F;
}

.header h1 {
  color: #212121;
  font-size: 2.2em;
  margin-bottom: 10px;
}

.title-text {
  background: linear-gradient(135deg, #F57C00 0%, #FFB300 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.subtitle {
  color: #616161;
  font-size: 1.1em;
  margin-top: 10px;
}

/* å¹´é¸æŠ */
.year-selector {
  margin-top: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
}

.year-dropdown {
  padding: 8px 20px;
  border-radius: 8px;
  border: 2px solid #FFD54F;
  font-size: 1.1em;
  cursor: pointer;
  background: white;
  font-weight: 600;
  color: #F57C00;
}

.year-btn {
  padding: 8px 16px;
  background: linear-gradient(135deg, #F57C00, #FFB300);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 0.95em;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(245, 124, 0, 0.3);
}

.year-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(245, 124, 0, 0.4);
  background: linear-gradient(135deg, #FF8F00, #FFC107);
}

.year-btn:disabled {
  background: #BDBDBD;
  cursor: not-allowed;
  opacity: 0.5;
  box-shadow: none;
}

.year-btn:disabled:hover {
  transform: none;
}

/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
.nav-buttons {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-bottom: 30px;
}

.nav-btn {
  padding: 12px 24px;
  background: white;
  color: #F57C00;
  border: 2px solid #F57C00;
  border-radius: 10px;
  font-size: 1em;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.nav-btn:hover {
  background: #F57C00;
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(245, 124, 0, 0.3);
}

/* å¹´é–“çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
.yearly-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 40px;
}

.yearly-stat-card {
  background: linear-gradient(145deg, #FFFFFF, #FFFBF5);
  border-radius: 16px;
  padding: 30px;
  text-align: center;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  border: 2px solid #FFD54F;
  transition: all 0.3s ease;
}

.yearly-stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.yearly-stat-label {
  font-size: 1.1em;
  color: #616161;
  margin-bottom: 15px;
  font-weight: 600;
}

.yearly-stat-value {
  font-size: 2.5em;
  font-weight: bold;
  background: linear-gradient(135deg, #F57C00 0%, #FFB300 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠ */
.chart-container {
  background: white;
  border-radius: 16px;
  padding: 30px;
  margin-bottom: 30px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  border: 2px solid #E0E0E0;
}

.chart-title {
  font-size: 1.4em;
  color: #212121;
  margin-bottom: 20px;
  font-weight: 600;
  text-align: center;
}

.chart-wrapper {
  position: relative;
  height: 350px;
  margin-bottom: 20px;
}

/* æœˆåˆ¥ã‚µãƒãƒªãƒ¼ã‚°ãƒªãƒƒãƒ‰ */
.monthly-summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 30px;
}

.monthly-summary-card {
  background: linear-gradient(145deg, #F5F5F5, #FFFFFF);
  border-radius: 12px;
  padding: 20px;
  border: 1px solid #E0E0E0;
  transition: all 0.3s ease;
}

.monthly-summary-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.monthly-summary-header {
  font-size: 1.1em;
  font-weight: 600;
  color: #F57C00;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 2px solid #FFD54F;
  text-align: center;
}

.monthly-summary-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-size: 0.9em;
}

.monthly-summary-label {
  color: #616161;
}

.monthly-summary-value {
  font-weight: 600;
  color: #212121;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
  .container {
    padding: 20px;
  }

  .header h1 {
    font-size: 1.8em;
  }

  .yearly-stats {
    grid-template-columns: 1fr;
  }

  .yearly-stat-value {
    font-size: 2em;
  }

  .chart-wrapper {
    height: 250px;
  }

  .nav-buttons {
    flex-direction: column;
  }

  .nav-btn {
    width: 100%;
    justify-content: center;
  }
}

/* ãƒ‡ãƒ¼ã‚¿ãªã—è¡¨ç¤º */
.no-data-message {
  text-align: center;
  padding: 60px 20px;
  color: #9E9E9E;
  font-size: 1.2em;
}

.no-data-icon {
  font-size: 4em;
  margin-bottom: 20px;
}
</style>
</head>
<body>

<div class="container">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <h1>ğŸ“Š <span class="title-text"><span id="display-year">2025</span>å¹´ å¹´é–“ã‚µãƒãƒªãƒ¼</span></h1>
    <p class="subtitle">ã‚ãªãŸã®å¥åº·ç®¡ç†å®Ÿç¸¾ã‚’æŒ¯ã‚Šè¿”ã‚Šã¾ã—ã‚‡ã†</p>
    
    <!-- å¹´é¸æŠ -->
    <div class="year-selector">
      <button id="prev-year" class="year-btn" onclick="changeYear(-1)">â€¹ å‰å¹´</button>
      <select id="year-select" class="year-dropdown" onchange="onYearChange()">
        <option value="2024">2024å¹´</option>
        <option value="2025" selected>2025å¹´</option>
        <option value="2026">2026å¹´</option>
      </select>
      <button id="next-year" class="year-btn" onclick="changeYear(1)">æ¬¡å¹´ â€º</button>
    </div>
  </div>

  <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
  <div class="nav-buttons">
    <a href="home.html" class="nav-btn">
      <span>ğŸ </span>
      <span>ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</span>
    </a>
    <a href="calendar.html" class="nav-btn">
      <span>ğŸ“…</span>
      <span>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¦‹ã‚‹</span>
    </a>
    <a href="timeline.html" class="nav-btn">
      <span>ğŸ“‹</span>
      <span>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</span>
    </a>
    <a href="features.html" class="nav-btn">
      <span>ğŸ“–</span>
      <span>ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</span>
    </a>
  </div>

  <!-- å¹´é–“çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
  <div class="yearly-stats">
    <div class="yearly-stat-card">
      <div class="yearly-stat-label">ğŸ«€ å¹´é–“å¹³å‡è¡€åœ§</div>
      <div class="yearly-stat-value" id="yearly-avg-bp">--/--</div>
    </div>
    <div class="yearly-stat-card">
      <div class="yearly-stat-label">âš–ï¸ å¹´é–“å¹³å‡ä½“é‡</div>
      <div class="yearly-stat-value" id="yearly-avg-weight">-- kg</div>
    </div>
    <div class="yearly-stat-card">
      <div class="yearly-stat-label">ğŸƒ å¹´é–“é‹å‹•å®Ÿæ–½æ—¥æ•°</div>
      <div class="yearly-stat-value" id="yearly-total-days">0 æ—¥</div>
    </div>
    <div class="yearly-stat-card">
      <div class="yearly-stat-label">â±ï¸ å¹´é–“é‹å‹•æ™‚é–“</div>
      <div class="yearly-stat-value" id="yearly-total-time">0 åˆ†</div>
    </div>
    <div class="yearly-stat-card">
      <div class="yearly-stat-label">ğŸ”¥ å¹´é–“æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼</div>
      <div class="yearly-stat-value" id="yearly-total-calories">0 kcal</div>
    </div>
  </div>

  <!-- æœˆåˆ¥å¹³å‡è¡€åœ§æ¨ç§» -->
  <div class="chart-container">
    <div class="chart-title">ğŸ«€ æœˆåˆ¥å¹³å‡è¡€åœ§æ¨ç§»</div>
    <div class="chart-wrapper">
      <canvas id="bp-chart"></canvas>
    </div>
  </div>

  <!-- æœˆåˆ¥å¹³å‡ä½“é‡æ¨ç§» -->
  <div class="chart-container">
    <div class="chart-title">âš–ï¸ æœˆåˆ¥å¹³å‡ä½“é‡æ¨ç§»</div>
    <div class="chart-wrapper">
      <canvas id="weight-chart"></canvas>
    </div>
  </div>

  <!-- æœˆåˆ¥ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ—¥æ•° -->
  <div class="chart-container">
    <div class="chart-title">ğŸƒ æœˆåˆ¥é‹å‹•å®Ÿæ–½æ—¥æ•°</div>
    <div class="chart-wrapper">
      <canvas id="days-chart"></canvas>
    </div>
  </div>

  <!-- æœˆåˆ¥é‹å‹•æ™‚é–“ -->
  <div class="chart-container">
    <div class="chart-title">â±ï¸ æœˆåˆ¥é‹å‹•æ™‚é–“</div>
    <div class="chart-wrapper">
      <canvas id="time-chart"></canvas>
    </div>
  </div>

  <!-- æœˆåˆ¥æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼ -->
  <div class="chart-container">
    <div class="chart-title">ğŸ”¥ æœˆåˆ¥æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼</div>
    <div class="chart-wrapper">
      <canvas id="calories-chart"></canvas>
    </div>
  </div>

  <!-- æœˆåˆ¥è©³ç´°ã‚µãƒãƒªãƒ¼ -->
  <div class="chart-container">
    <div class="chart-title">ğŸ“‹ æœˆåˆ¥è©³ç´°ã‚µãƒãƒªãƒ¼</div>
    <div class="monthly-summary-grid" id="monthly-details">
      <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
    </div>
  </div>
</div>

<script>
// é¸æŠä¸­ã®å¹´ï¼ˆåˆæœŸå€¤ã¯ç¾åœ¨ã®å¹´ï¼‰
let selectedYear = new Date().getFullYear();

// æœˆåã®é…åˆ—
const monthNames = ['january', 'february', 'march', 'april', 'may', 'june', 
                   'july', 'august', 'september', 'october', 'november', 'december'];

// å¹´é¸æŠã‚’åˆæœŸåŒ–
function initializeYearSelector() {
  document.getElementById('year-select').value = selectedYear;
  document.getElementById('display-year').textContent = selectedYear;
  updateYearButtons();
}

// å¹´é¸æŠå¤‰æ›´æ™‚
function onYearChange() {
  const yearSelect = document.getElementById('year-select');
  selectedYear = parseInt(yearSelect.value);
  document.getElementById('display-year').textContent = selectedYear;
  updateYearButtons();
  loadYearlyData();
}

// å¹´å¤‰æ›´ãƒœã‚¿ãƒ³
function changeYear(delta) {
  const newYear = selectedYear + delta;
  if (newYear >= 2024 && newYear <= 2026) {
    selectedYear = newYear;
    document.getElementById('year-select').value = selectedYear;
    document.getElementById('display-year').textContent = selectedYear;
    updateYearButtons();
    loadYearlyData();
  }
}

// å¹´ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’æ›´æ–°
function updateYearButtons() {
  const prevBtn = document.getElementById('prev-year');
  const nextBtn = document.getElementById('next-year');
  
  prevBtn.disabled = (selectedYear <= 2024);
  nextBtn.disabled = (selectedYear >= 2026);
}

// å…¨æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
function getAllMonthsData() {
  const allData = {};
  
  for (let month = 0; month < 12; month++) {
    const monthData = {};
    
    // æ–¹æ³•1: æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼ï¼ˆnovember2025_dataå½¢å¼ï¼‰ã‚’ç¢ºèª
    const monthKey = `${monthNames[month]}${selectedYear}_data`;
    const monthDataStr = localStorage.getItem(monthKey);
    
    if (monthDataStr) {
      try {
        const parsed = JSON.parse(monthDataStr);
        // calendarã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        if (parsed.calendar) {
          Object.assign(monthData, parsed.calendar);
        }
      } catch (e) {
        console.error(`Error parsing ${monthKey}:`, e);
      }
    }
    
    // æ–¹æ³•2: æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼ï¼ˆtraining_2025_10_4å½¢å¼ï¼‰ã‚’ç¢ºèª
    const daysInMonth = new Date(selectedYear, month + 1, 0).getDate();
    for (let day = 1; day <= daysInMonth; day++) {
      const dayKey = `training_${selectedYear}_${month}_${day}`;
      const dayDataStr = localStorage.getItem(dayKey);
      
      if (dayDataStr) {
        try {
          const dayData = JSON.parse(dayDataStr);
          // ã“ã®å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚‚ä¿å­˜ï¼ˆæ—¥åˆ¥ã‚­ãƒ¼ãŒå„ªå…ˆï¼‰
          monthData[day] = dayData;
        } catch (e) {
          console.error(`Error parsing ${dayKey}:`, e);
        }
      }
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿è¿½åŠ 
    if (Object.keys(monthData).length > 0) {
      allData[month] = monthData;
    }
  }
  
  return allData;
}

// æœˆåˆ¥çµ±è¨ˆã®è¨ˆç®—
function calculateMonthlyStats(monthData) {
  const days = Object.keys(monthData).filter(key => key !== 'goals');
  
  if (days.length === 0) {
    return {
      avgBP: null,
      avgWeight: null,
      trainingDays: 0,
      totalCalories: 0,
      totalTime: 0
    };
  }

  let totalSystolic = 0;
  let totalDiastolic = 0;
  let totalWeight = 0;
  let bpCount = 0;
  let weightCount = 0;
  let trainingDays = 0;
  let totalCalories = 0;
  let totalTime = 0;

  days.forEach(day => {
    const data = monthData[day];
    
    // === è¡€åœ§ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ï¼ˆ3ã¤ã®å½¢å¼ã«å¯¾å¿œï¼‰ ===
    
    // å½¢å¼1: data.bloodPressure.systolic/diastolic (training_2025_10_4å½¢å¼)
    if (data.bloodPressure && typeof data.bloodPressure === 'object') {
      if (data.bloodPressure.systolic && data.bloodPressure.diastolic) {
        totalSystolic += parseInt(data.bloodPressure.systolic);
        totalDiastolic += parseInt(data.bloodPressure.diastolic);
        bpCount++;
      }
    }
    // å½¢å¼2: data.bp ã¨ã„ã†æ–‡å­—åˆ— "120/80" (calendarå½¢å¼)
    else if (data.bp && typeof data.bp === 'string' && data.bp.trim() !== '') {
      const bpParts = data.bp.split('/');
      if (bpParts.length === 2) {
        const systolic = parseInt(bpParts[0]);
        const diastolic = parseInt(bpParts[1]);
        if (!isNaN(systolic) && !isNaN(diastolic)) {
          totalSystolic += systolic;
          totalDiastolic += diastolic;
          bpCount++;
        }
      }
    }
    // å½¢å¼3: data.systolic ã¨ data.diastolic ãŒåˆ¥ã€…
    else if (data.systolic && data.diastolic) {
      totalSystolic += parseInt(data.systolic);
      totalDiastolic += parseInt(data.diastolic);
      bpCount++;
    }
    
    // === ä½“é‡ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç† ===
    if (data.weight) {
      const weight = parseFloat(data.weight);
      if (!isNaN(weight)) {
        totalWeight += weight;
        weightCount++;
      }
    }
    
    // === ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°åˆ¤å®šï¼ˆè¤‡æ•°ã®å½¢å¼ã«å¯¾å¿œï¼‰ ===
    let hasTraining = false;
    
    // å½¢å¼1: exercisesé…åˆ—ãŒã‚ã‚‹
    if (data.exercises && Array.isArray(data.exercises) && data.exercises.length > 0) {
      hasTraining = true;
    }
    // å½¢å¼2: time ã¾ãŸã¯ calories ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹
    else if ((data.time && data.time.toString().trim() !== '') || 
             (data.calories && data.calories.toString().trim() !== '')) {
      hasTraining = true;
    }
    // å½¢å¼3: totalTime ãŒã‚ã‚‹
    else if (data.totalTime && parseInt(data.totalTime) > 0) {
      hasTraining = true;
    }
    
    if (hasTraining) {
      trainingDays++;
    }
    
    // === ã‚«ãƒ­ãƒªãƒ¼ã®å‡¦ç† ===
    if (data.totalCalories) {
      const cal = parseInt(data.totalCalories);
      if (!isNaN(cal)) totalCalories += cal;
    } else if (data.calories) {
      const cal = parseInt(data.calories);
      if (!isNaN(cal)) totalCalories += cal;
    }
    
    // === é‹å‹•æ™‚é–“ã®å‡¦ç† ===
    if (data.totalTime) {
      const time = parseInt(data.totalTime);
      if (!isNaN(time)) totalTime += time;
    } else if (data.time) {
      const time = parseInt(data.time);
      if (!isNaN(time)) totalTime += time;
    }
  });

  return {
    avgBP: bpCount > 0 ? {
      systolic: Math.round(totalSystolic / bpCount),
      diastolic: Math.round(totalDiastolic / bpCount)
    } : null,
    avgWeight: weightCount > 0 ? (totalWeight / weightCount).toFixed(1) : null,
    trainingDays: trainingDays,
    totalCalories: totalCalories,
    totalTime: totalTime
  };
}

// å¹´é–“çµ±è¨ˆã®è¨ˆç®—
function calculateYearlyStats(allData) {
  const months = Object.keys(allData);
  
  if (months.length === 0) {
    return {
      avgBP: null,
      avgWeight: null,
      totalTrainingDays: 0,
      totalCalories: 0,
      totalTime: 0
    };
  }

  let totalSystolic = 0;
  let totalDiastolic = 0;
  let totalWeight = 0;
  let bpCount = 0;
  let weightCount = 0;
  let totalTrainingDays = 0;
  let totalCalories = 0;
  let totalTime = 0;

  months.forEach(month => {
    const stats = calculateMonthlyStats(allData[month]);
    
    if (stats.avgBP) {
      totalSystolic += stats.avgBP.systolic;
      totalDiastolic += stats.avgBP.diastolic;
      bpCount++;
    }
    
    if (stats.avgWeight) {
      totalWeight += parseFloat(stats.avgWeight);
      weightCount++;
    }
    
    totalTrainingDays += stats.trainingDays;
    totalCalories += stats.totalCalories;
    totalTime += stats.totalTime;
  });

  return {
    avgBP: bpCount > 0 ? {
      systolic: Math.round(totalSystolic / bpCount),
      diastolic: Math.round(totalDiastolic / bpCount)
    } : null,
    avgWeight: weightCount > 0 ? (totalWeight / weightCount).toFixed(1) : null,
    totalTrainingDays: totalTrainingDays,
    totalCalories: totalCalories,
    totalTime: totalTime
  };
}

// å¹´é–“çµ±è¨ˆã®è¡¨ç¤º
function displayYearlyStats(stats) {
  // å¹³å‡è¡€åœ§
  if (stats.avgBP) {
    document.getElementById('yearly-avg-bp').textContent = 
      `${stats.avgBP.systolic}/${stats.avgBP.diastolic}`;
  } else {
    document.getElementById('yearly-avg-bp').textContent = '--/--';
  }
  
  // å¹³å‡ä½“é‡
  if (stats.avgWeight) {
    document.getElementById('yearly-avg-weight').textContent = `${stats.avgWeight} kg`;
  } else {
    document.getElementById('yearly-avg-weight').textContent = '-- kg';
  }
  
  // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ—¥æ•°
  document.getElementById('yearly-total-days').textContent = `${stats.totalTrainingDays} æ—¥`;
  
  // æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼
  document.getElementById('yearly-total-calories').textContent = 
    `${stats.totalCalories.toLocaleString()} kcal`;
  
  // é‹å‹•æ™‚é–“
  document.getElementById('yearly-total-time').textContent = `${stats.totalTime} åˆ†`;
}

// ã‚°ãƒ©ãƒ•ã®ä½œæˆ
function createCharts(allData) {
  const monthLabels = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', 
                      '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
  
  const monthlyStats = [];
  for (let i = 0; i < 12; i++) {
    if (allData[i]) {
      monthlyStats[i] = calculateMonthlyStats(allData[i]);
    } else {
      monthlyStats[i] = {
        avgBP: null,
        avgWeight: null,
        trainingDays: 0,
        totalCalories: 0,
        totalTime: 0
      };
    }
  }

  // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ã‚’ç ´æ£„
  if (window.bpChart) window.bpChart.destroy();
  if (window.weightChart) window.weightChart.destroy();
  if (window.daysChart) window.daysChart.destroy();
  if (window.caloriesChart) window.caloriesChart.destroy();
  if (window.timeChart) window.timeChart.destroy();

  // è¡€åœ§ã‚°ãƒ©ãƒ•
  const bpData = {
    systolic: monthlyStats.map(stat => stat.avgBP ? stat.avgBP.systolic : null),
    diastolic: monthlyStats.map(stat => stat.avgBP ? stat.avgBP.diastolic : null)
  };

  window.bpChart = new Chart(document.getElementById('bp-chart'), {
    type: 'line',
    data: {
      labels: monthLabels,
      datasets: [
        {
          label: 'åç¸®æœŸè¡€åœ§',
          data: bpData.systolic,
          borderColor: '#EF5350',
          backgroundColor: 'rgba(239, 83, 80, 0.1)',
          tension: 0.4,
          fill: true
        },
        {
          label: 'æ‹¡å¼µæœŸè¡€åœ§',
          data: bpData.diastolic,
          borderColor: '#42A5F5',
          backgroundColor: 'rgba(66, 165, 245, 0.1)',
          tension: 0.4,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          title: {
            display: true,
            text: 'è¡€åœ§ (mmHg)'
          }
        }
      }
    }
  });

  // ä½“é‡ã‚°ãƒ©ãƒ•
  const weightData = monthlyStats.map(stat => stat.avgWeight ? parseFloat(stat.avgWeight) : null);

  window.weightChart = new Chart(document.getElementById('weight-chart'), {
    type: 'line',
    data: {
      labels: monthLabels,
      datasets: [{
        label: 'å¹³å‡ä½“é‡',
        data: weightData,
        borderColor: '#66BB6A',
        backgroundColor: 'rgba(102, 187, 106, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          title: {
            display: true,
            text: 'ä½“é‡ (kg)'
          }
        }
      }
    }
  });

  // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ—¥æ•°ã‚°ãƒ©ãƒ•
  const daysData = monthlyStats.map(stat => stat.trainingDays);

  window.daysChart = new Chart(document.getElementById('days-chart'), {
    type: 'bar',
    data: {
      labels: monthLabels,
      datasets: [{
        label: 'é‹å‹•å®Ÿæ–½æ—¥æ•°',
        data: daysData,
        backgroundColor: 'rgba(255, 152, 0, 0.7)',
        borderColor: '#FF9800',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'æ—¥æ•°'
          }
        }
      }
    }
  });

  // ã‚«ãƒ­ãƒªãƒ¼ã‚°ãƒ©ãƒ•
  const caloriesData = monthlyStats.map(stat => stat.totalCalories);

  window.caloriesChart = new Chart(document.getElementById('calories-chart'), {
    type: 'bar',
    data: {
      labels: monthLabels,
      datasets: [{
        label: 'æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼',
        data: caloriesData,
        backgroundColor: 'rgba(156, 39, 176, 0.7)',
        borderColor: '#9C27B0',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'ã‚«ãƒ­ãƒªãƒ¼ (kcal)'
          }
        }
      }
    }
  });

  // é‹å‹•æ™‚é–“ã‚°ãƒ©ãƒ•
  const timeData = monthlyStats.map(stat => stat.totalTime);

  window.timeChart = new Chart(document.getElementById('time-chart'), {
    type: 'bar',
    data: {
      labels: monthLabels,
      datasets: [{
        label: 'é‹å‹•æ™‚é–“',
        data: timeData,
        backgroundColor: 'rgba(3, 169, 244, 0.7)',
        borderColor: '#03A9F4',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'æ™‚é–“ (åˆ†)'
          }
        }
      }
    }
  });
}

// æœˆåˆ¥è©³ç´°ã®è¡¨ç¤º
function displayMonthlyDetails(allData) {
  const container = document.getElementById('monthly-details');
  const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', 
                     '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
  
  container.innerHTML = '';
  
  for (let i = 0; i < 12; i++) {
    const stats = allData[i] ? calculateMonthlyStats(allData[i]) : null;
    
    const card = document.createElement('div');
    card.className = 'monthly-summary-card';
    
    let content = `<div class="monthly-summary-header">${monthNames[i]}</div>`;
    
    if (stats && stats.trainingDays > 0) {
      content += `
        <div class="monthly-summary-item">
          <span class="monthly-summary-label">å¹³å‡è¡€åœ§</span>
          <span class="monthly-summary-value">${stats.avgBP ? `${stats.avgBP.systolic}/${stats.avgBP.diastolic}` : '--'}</span>
        </div>
        <div class="monthly-summary-item">
          <span class="monthly-summary-label">å¹³å‡ä½“é‡</span>
          <span class="monthly-summary-value">${stats.avgWeight ? `${stats.avgWeight} kg` : '--'}</span>
        </div>
        <div class="monthly-summary-item">
          <span class="monthly-summary-label">é‹å‹•å®Ÿæ–½æ—¥æ•°</span>
          <span class="monthly-summary-value">${stats.trainingDays} æ—¥</span>
        </div>
        <div class="monthly-summary-item">
          <span class="monthly-summary-label">é‹å‹•æ™‚é–“</span>
          <span class="monthly-summary-value">${stats.totalTime} åˆ†</span>
        </div>
        <div class="monthly-summary-item">
          <span class="monthly-summary-label">ç·ã‚«ãƒ­ãƒªãƒ¼</span>
          <span class="monthly-summary-value">${stats.totalCalories.toLocaleString()} kcal</span>
        </div>
      `;
    } else {
      content += '<div style="text-align: center; color: #9E9E9E; padding: 20px;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
    }
    
    card.innerHTML = content;
    container.appendChild(card);
  }
}

// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function loadYearlyData() {
  const allData = getAllMonthsData();
  const yearlyStats = calculateYearlyStats(allData);
  
  // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  if (Object.keys(allData).length === 0) {
    document.getElementById('yearly-avg-bp').textContent = '--/--';
    document.getElementById('yearly-avg-weight').textContent = '-- kg';
    document.getElementById('yearly-total-days').textContent = '0 æ—¥';
    document.getElementById('yearly-total-calories').textContent = '0 kcal';
    document.getElementById('yearly-total-time').textContent = '0 åˆ†';
    
    // ã‚°ãƒ©ãƒ•ã‚’ã‚¯ãƒªã‚¢
    if (window.bpChart) window.bpChart.destroy();
    if (window.weightChart) window.weightChart.destroy();
    if (window.daysChart) window.daysChart.destroy();
    if (window.caloriesChart) window.caloriesChart.destroy();
    if (window.timeChart) window.timeChart.destroy();
    
    // æœˆåˆ¥è©³ç´°ã‚’ã‚¯ãƒªã‚¢
    const container = document.getElementById('monthly-details');
    container.innerHTML = '<div style="text-align: center; color: #9E9E9E; padding: 40px;">ã“ã®å¹´ã®ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
    
    return;
  }
  
  // çµ±è¨ˆã®è¡¨ç¤º
  displayYearlyStats(yearlyStats);
  
  // ã‚°ãƒ©ãƒ•ã®ä½œæˆ
  createCharts(allData);
  
  // æœˆåˆ¥è©³ç´°ã®è¡¨ç¤º
  displayMonthlyDetails(allData);
}

// åˆæœŸåŒ–
window.addEventListener('DOMContentLoaded', function() {
  initializeYearSelector();
  loadYearlyData();
});
</script>

</body>
</html>