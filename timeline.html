<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ - ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç®¡ç†ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ 2025</title>
<style>
* { 
  margin: 0; 
  padding: 0; 
  box-sizing: border-box; 
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #FFF9C4 0%, #FFECB3 50%, #FFE082 100%);
  min-height: 100vh;
  padding: 20px;
  color: #212121;
}

.container {
  max-width: 900px;
  margin: 0 auto;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.header {
  background: white;
  border-radius: 20px 20px 0 0;
  padding: 30px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-bottom: 0;
}

.header-title {
  font-size: 2.5em;
  color: #212121;
  text-align: center;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.header-subtitle {
  text-align: center;
  color: #616161;
  font-size: 1.1em;
  margin-bottom: 20px;
}

/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
.nav-buttons {
  display: flex;
  justify-content: center;
  gap: 0;
  flex-wrap: wrap;
  margin-bottom: 20px;
  background: #F5F5F5;
  border-radius: 12px;
  padding: 4px;
}

.nav-btn {
  padding: 8px 16px;
  background: transparent;
  color: #616161;
  border: none;
  border-radius: 8px;
  font-size: 0.85em;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

.nav-btn:hover {
  background: rgba(245, 124, 0, 0.1);
  color: #F57C00;
}

.nav-btn.active {
  background: white;
  color: #F57C00;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ - NEW! */
.control-bar {
  background: white;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
  border-top: 1px solid #F5F5F5;
}

.date-selector-inline {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: #FAFAFA;
  border-radius: 10px;
  border: 2px solid #E0E0E0;
}

.label-text {
  font-weight: 600;
  color: #424242;
  font-size: 0.95em;
  white-space: nowrap;
}

.date-selector-inline select {
  padding: 6px 10px;
  border: 1px solid #E0E0E0;
  border-radius: 6px;
  font-size: 0.95em;
  background: white;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 600;
  color: #F57C00;
}

.date-selector-inline select:focus {
  outline: none;
  border-color: #F57C00;
  box-shadow: 0 0 0 2px rgba(245, 124, 0, 0.1);
}

/* è¡¨ç¤ºè¨­å®šãƒœã‚¿ãƒ³ */
.btn-display-settings {
  padding: 10px 20px;
  background: linear-gradient(135deg, #F57C00, #FFB300);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 0.95em;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(245, 124, 0, 0.2);
}

.btn-display-settings:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(245, 124, 0, 0.3);
}

/* è¨­å®šãƒ‘ãƒãƒ« */
.settings-panel {
  background: white;
  border-top: 1px solid #F5F5F5;
  padding: 20px;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    max-height: 0;
  }
  to {
    opacity: 1;
    max-height: 500px;
  }
}

.settings-panel-header {
  font-size: 1.1em;
  font-weight: 600;
  color: #F57C00;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 2px solid #FFD54F;
}

.settings-panel-title {
  font-size: 1em;
}

.settings-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  border-radius: 8px;
  transition: background 0.3s ease;
}

.settings-item:hover {
  background: #FAFAFA;
}

.settings-item-label {
  font-size: 0.95em;
  color: #424242;
  font-weight: 500;
}

/* ã‚µãƒ–é …ç›®ã‚³ãƒ³ãƒ†ãƒŠ */
.settings-sub-items {
  margin-left: 20px;
  padding-left: 10px;
  transition: all 0.3s ease;
}

.settings-sub-items.hidden {
  display: none;
}

/* ã‚µãƒ–é …ç›®ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.settings-item-sub {
  padding: 10px 12px;
}

.settings-item-sub:hover {
  background: #FFF9C4;
}

.settings-item-sub .settings-item-label {
  font-size: 0.9em;
  color: #616161;
  font-weight: 400;
}

/* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
.toggle-switch {
  width: 50px;
  height: 26px;
  background: #CCC;
  border-radius: 13px;
  position: relative;
  cursor: pointer;
  transition: background 0.3s ease;
}

.toggle-switch.active {
  background: #4CAF50;
}

.toggle-switch-knob {
  width: 22px;
  height: 22px;
  background: white;
  border-radius: 50%;
  position: absolute;
  top: 2px;
  left: 2px;
  transition: transform 0.3s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.toggle-switch.active .toggle-switch-knob {
  transform: translateX(24px);
}


/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
.content {
  background: white;
  border-radius: 0 0 20px 20px;
  padding: 30px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ« */
.section-title {
  font-size: 1.5em;
  font-weight: 600;
  color: #212121;
  margin-bottom: 20px;
  text-align: center;
  padding-bottom: 15px;
  border-bottom: 2px solid #FFD54F;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.record-count {
  font-size: 0.7em;
  color: #616161;
  font-weight: normal;
}

/* å¹´ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ */
.year-separator {
  display: flex;
  align-items: center;
  gap: 15px;
  margin: 30px 0 20px 0;
}

.year-separator .line {
  flex: 1;
  height: 2px;
  background: linear-gradient(to right, transparent, #F57C00, transparent);
}

.year-separator .year-text {
  font-size: 0.9em;
  font-weight: 600;
  color: #616161;
  white-space: nowrap;
  padding: 4px 12px;
  background: #F5F5F5;
  border-radius: 12px;
  border: 1px solid #E0E0E0;
}

/* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
.timeline-container {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ */
.timeline-card {
  background: white;
  border: 2px solid #E0E0E0;
  border-radius: 16px;
  padding: 24px;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.timeline-card:hover {
  border-color: #FFB300;
  box-shadow: 0 4px 16px rgba(245, 124, 0, 0.15);
  transform: translateY(-2px);
}

.timeline-card.recorded {
  border-color: #66BB6A;
  background: linear-gradient(145deg, #E8F5E9, #FFFFFF);
}

/* ã‚«ãƒ¼ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼ */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #F5F5F5;
}

.card-date {
  font-size: 1.4em;
  font-weight: 600;
  color: #212121;
  display: flex;
  align-items: center;
  gap: 8px;
}

.card-weekday {
  font-size: 0.75em;
  color: #616161;
  font-weight: normal;
  margin-left: 8px;
}

/* ã‚«ãƒ¼ãƒ‰ãƒœãƒ‡ã‚£ */
.card-body {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
}

.data-section {
  padding: 16px;
  background: #FAFAFA;
  border-radius: 12px;
  border-left: 4px solid #FFB300;
}

.data-header {
  font-size: 1.1em;
  font-weight: 600;
  color: #424242;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.data-content {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.data-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
}

.data-label {
  font-size: 0.95em;
  color: #616161;
}

.data-value {
  font-size: 1.1em;
  font-weight: 600;
  color: #212121;
}

.data-change {
  font-size: 0.85em;
  margin-left: 8px;
}

.data-change.positive {
  color: #4CAF50;
}

.data-change.negative {
  color: #EF5350;
}

.empty-message {
  text-align: center;
  color: #9E9E9E;
  font-size: 0.95em;
  padding: 10px;
}

/* é‹å‹•ãƒªã‚¹ãƒˆ */
.training-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.training-item {
  background: white;
  padding: 12px;
  border-radius: 8px;
  border-left: 3px solid #F57C00;
  transition: all 0.3s ease;
}

.training-item:hover {
  transform: translateX(3px);
  box-shadow: 0 2px 6px rgba(245, 124, 0, 0.15);
}

.training-name {
  font-weight: 600;
  color: #424242;
  margin-bottom: 5px;
}

.training-details {
  font-size: 0.9em;
  color: #616161;
}

/* ã‚‚ã£ã¨è¦‹ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.load-more-section {
  text-align: center;
  padding: 30px 0;
}

.load-more-section.hidden {
  display: none;
}

.btn-load-more {
  padding: 12px 40px;
  background: linear-gradient(135deg, #F57C00, #FFB300);
  color: white;
  border: none;
  border-radius: 25px;
  font-size: 1.05em;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(245, 124, 0, 0.3);
}

.btn-load-more:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(245, 124, 0, 0.4);
}

.btn-load-more:disabled {
  background: #BDBDBD;
  cursor: not-allowed;
  box-shadow: none;
}

/* ç©ºã®çŠ¶æ…‹ */
.empty-state {
  text-align: center;
  padding: 60px 20px;
}

.empty-icon {
  font-size: 80px;
  margin-bottom: 20px;
  opacity: 0.5;
}

.empty-title {
  font-size: 1.5em;
  font-weight: 600;
  color: #424242;
  margin-bottom: 10px;
}

.empty-description {
  color: #757575;
  font-size: 1.05em;
  margin-bottom: 20px;
}

.empty-action {
  display: inline-block;
  padding: 12px 30px;
  background: linear-gradient(135deg, #F57C00, #FFB300);
  color: white;
  border-radius: 25px;
  text-decoration: none;
  font-weight: 600;
  transition: all 0.3s ease;
}

.empty-action:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(245, 124, 0, 0.3);
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width: 768px) {
  body {
    padding: 10px;
  }

  .header {
    padding: 20px;
  }

  .header-title {
    font-size: 2em;
  }

  .content {
    padding: 20px;
  }

  .nav-buttons {
    padding: 3px;
  }

  .nav-btn {
    padding: 6px 12px;
    font-size: 0.8em;
    gap: 3px;
  }

  .control-bar {
    flex-direction: column;
    align-items: stretch;
  }

  .date-selector-inline {
    justify-content: center;
  }

  .filter-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .filter-btn {
    padding: 12px 16px;
    font-size: 0.95em;
  }

  .card-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  .card-date {
    font-size: 1.2em;
  }

  .data-section {
    padding: 12px;
  }
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ - NEW! */
.loading {
  text-align: center;
  padding: 40px;
  color: #616161;
}

.loading-spinner {
  display: inline-block;
  width: 40px;
  height: 40px;
  border: 4px solid #E0E0E0;
  border-top-color: #F57C00;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 15px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>
<body>

<div class="container">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <div class="header-title">ğŸ“‹ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="nav-buttons">
      <a href="home.html" class="nav-btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a href="calendar.html" class="nav-btn">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
      <a href="timeline.html" class="nav-btn active">ğŸ“‹ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</a>
      <a href="yearly-summary.html" class="nav-btn">ğŸ“ˆ å¹´é–“ã‚µãƒãƒªãƒ¼</a>
      <a href="features.html" class="nav-btn">â“ ä½¿ã„æ–¹</a>
    </div>
  </div>

  <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ -->
  <div class="control-bar">
    <!-- å¹´æœˆé¸æŠ -->
    <div class="date-selector-inline">
      <span class="label-text">è¡¨ç¤ºæœŸé–“ï¼š</span>
      <select id="select-year"></select>
      <select id="select-month">
        <option value="1">1æœˆ</option>
        <option value="2">2æœˆ</option>
        <option value="3">3æœˆ</option>
        <option value="4">4æœˆ</option>
        <option value="5">5æœˆ</option>
        <option value="6">6æœˆ</option>
        <option value="7">7æœˆ</option>
        <option value="8">8æœˆ</option>
        <option value="9">9æœˆ</option>
        <option value="10">10æœˆ</option>
        <option value="11">11æœˆ</option>
        <option value="12">12æœˆ</option>
      </select>
      <span class="label-text">ä»¥å‰</span>
    </div>

    <!-- è¡¨ç¤ºè¨­å®šãƒœã‚¿ãƒ³ -->
    <button class="btn-display-settings" id="btnDisplaySettings">âš™ï¸ è¡¨ç¤ºè¨­å®š</button>
  </div>

  <!-- è¨­å®šãƒ‘ãƒãƒ« -->
  <div class="settings-panel" id="settingsPanel" style="display: none;">
    <div class="settings-panel-header">
      <span class="settings-panel-title">è¡¨ç¤ºé …ç›®ã®è¨­å®š</span>
    </div>
    
    <div class="settings-item">
      <span class="settings-item-label">ğŸ’“ è¡€åœ§ï¼ˆæœ€é«˜/æœ€ä½ï¼‰</span>
      <div class="toggle-switch active" data-item="bloodPressure">
        <div class="toggle-switch-knob"></div>
      </div>
    </div>
    
    <div class="settings-item">
      <span class="settings-item-label">âš–ï¸ ä½“é‡</span>
      <div class="toggle-switch active" data-item="weight">
        <div class="toggle-switch-knob"></div>
      </div>
    </div>
    
    <div class="settings-item">
      <span class="settings-item-label">ğŸ”¥ é‹å‹•è¨˜éŒ²</span>
      <div class="toggle-switch active" data-item="exerciseRecord">
        <div class="toggle-switch-knob"></div>
      </div>
    </div>
    
    <!-- é‹å‹•è¨˜éŒ²ã®ã‚µãƒ–é …ç›® -->
    <div class="settings-sub-items" id="exerciseSubItems">
      <div class="settings-item settings-item-sub">
        <span class="settings-item-label">â±ï¸ æ™‚é–“</span>
        <div class="toggle-switch active" data-item="trainingTime" data-parent="exerciseRecord">
          <div class="toggle-switch-knob"></div>
        </div>
      </div>
      
      <div class="settings-item settings-item-sub">
        <span class="settings-item-label">ğŸ”¥ ã‚«ãƒ­ãƒªãƒ¼</span>
        <div class="toggle-switch active" data-item="calories" data-parent="exerciseRecord">
          <div class="toggle-switch-knob"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="content">
    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ« -->
    <div class="section-title">
      ğŸ—“ï¸ è¨˜éŒ²ä¸€è¦§
      <span class="record-count" id="record-count"></span>
    </div>

    <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
    <div class="timeline-container" id="timeline-container">
      <!-- å‹•çš„ã«ç”Ÿæˆ -->
    </div>

    <!-- ã‚‚ã£ã¨è¦‹ã‚‹ -->
    <div class="load-more-section" id="load-more-section">
      <button class="btn-load-more" id="btn-load-more">ã‚‚ã£ã¨è¦‹ã‚‹</button>
    </div>
  </div>
</div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth() + 1;
let allRecords = [];
let displayedRecords = 0;
const recordsPerPage = 10;

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
  initYearSelector();
  loadTimeline();
  applyDisplaySettings(); // è¡¨ç¤ºè¨­å®šã‚’é©ç”¨

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  document.getElementById('select-year').addEventListener('change', onMonthChange);
  document.getElementById('select-month').addEventListener('change', onMonthChange);
  document.getElementById('btn-load-more').addEventListener('click', loadMoreRecords);

  // è¡¨ç¤ºè¨­å®šãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯
  const btnDisplaySettings = document.getElementById('btnDisplaySettings');
  const settingsPanel = document.getElementById('settingsPanel');
  
  if (btnDisplaySettings && settingsPanel) {
    btnDisplaySettings.addEventListener('click', function() {
      if (settingsPanel.style.display === 'none' || settingsPanel.style.display === '') {
        settingsPanel.style.display = 'block';
      } else {
        settingsPanel.style.display = 'none';
      }
    });
  }

  // ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒã®ã‚¯ãƒªãƒƒã‚¯
  const toggleSwitches = document.querySelectorAll('.toggle-switch');
  toggleSwitches.forEach(toggle => {
    toggle.addEventListener('click', function() {
      const itemKey = this.getAttribute('data-item');
      const parentKey = this.getAttribute('data-parent');
      if (!itemKey) return;
      
      // ç¾åœ¨ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
      const settings = loadDisplaySettings();
      
      // è¦ªé …ç›®ã®å ´åˆ
      if (itemKey === 'exerciseRecord') {
        settings[itemKey] = !settings[itemKey];
        
        if (!settings[itemKey]) {
          settings.trainingTime = false;
          settings.calories = false;
        } else {
          settings.trainingTime = true;
          settings.calories = true;
        }
      }
      // ã‚µãƒ–é …ç›®ã®å ´åˆ
      else if (parentKey) {
        settings[itemKey] = !settings[itemKey];
        
        // ä¸¡æ–¹ãŒOFFã«ãªã£ãŸå ´åˆã€è¦ªã‚‚OFF
        if (!settings.trainingTime && !settings.calories) {
          settings.exerciseRecord = false;
        } else {
          settings.exerciseRecord = true;
        }
      }
      // é€šå¸¸ã®é …ç›®ã®å ´åˆ
      else {
        settings[itemKey] = !settings[itemKey];
      }
      
      // ä¿å­˜
      saveDisplaySettings(settings);
      
      // UIã«é©ç”¨
      applyDisplaySettings();
      
      // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å†æç”»
      displayedRecords = 0;
      document.getElementById('timeline-container').innerHTML = '';
      loadMoreRecords();
    });
  });
});

// å¹´ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼åˆæœŸåŒ–
function initYearSelector() {
  const selectYear = document.getElementById('select-year');
  const currentYearValue = new Date().getFullYear();
  
  for (let year = currentYearValue - 2; year <= currentYearValue + 1; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = `${year}å¹´`;
    if (year === currentYear) {
      option.selected = true;
    }
    selectYear.appendChild(option);
  }

  const selectMonth = document.getElementById('select-month');
  selectMonth.value = currentMonth;
}

// æœˆå¤‰æ›´æ™‚
function onMonthChange() {
  currentYear = parseInt(document.getElementById('select-year').value);
  currentMonth = parseInt(document.getElementById('select-month').value);
  loadTimeline();
}

// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³èª­ã¿è¾¼ã¿
function loadTimeline() {
  // ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆæŒ‡å®šå¹´æœˆä»¥å‰ã®å…¨è¨˜éŒ²ï¼‰
  allRecords = getRecordsUpToMonth(currentYear, currentMonth);
  
  // åˆæœŸçŠ¶æ…‹
  displayedRecords = 0;
  document.getElementById('timeline-container').innerHTML = '';
  
  // ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°è¡¨ç¤º
  document.getElementById('record-count').textContent = 
    `(${allRecords.length}ä»¶)`;

  // åˆå›ãƒ­ãƒ¼ãƒ‰
  loadMoreRecords();
}

// ===== è¡¨ç¤ºè¨­å®šæ©Ÿèƒ½ =====

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¡¨ç¤ºè¨­å®š
const DEFAULT_DISPLAY_SETTINGS = {
  bloodPressure: true,
  weight: true,
  exerciseRecord: true,
  trainingTime: true,
  calories: true
};

// è¡¨ç¤ºè¨­å®šã‚’èª­ã¿è¾¼ã‚€
function loadDisplaySettings() {
  try {
    const settingsStr = localStorage.getItem('summary_display_settings');
    if (settingsStr) {
      return { ...DEFAULT_DISPLAY_SETTINGS, ...JSON.parse(settingsStr) };
    }
  } catch (e) {
    console.error('è¡¨ç¤ºè¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
  }
  return { ...DEFAULT_DISPLAY_SETTINGS };
}

// è¡¨ç¤ºè¨­å®šã‚’ä¿å­˜ã™ã‚‹
function saveDisplaySettings(settings) {
  try {
    localStorage.setItem('summary_display_settings', JSON.stringify(settings));
  } catch (e) {
    console.error('è¡¨ç¤ºè¨­å®šã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
  }
}

// è¡¨ç¤ºè¨­å®šã‚’UIã«é©ç”¨ã™ã‚‹
function applyDisplaySettings() {
  const settings = loadDisplaySettings();
  
  // é‹å‹•è¨˜éŒ²ã®è¦ªé …ç›®ãŒOFFã®å ´åˆã€ã‚µãƒ–é …ç›®ã‚‚éè¡¨ç¤º
  const subItems = document.getElementById('exerciseSubItems');
  if (subItems) {
    if (!settings.exerciseRecord) {
      subItems.classList.add('hidden');
    } else {
      subItems.classList.remove('hidden');
    }
  }
  
  // ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒã®çŠ¶æ…‹ã‚’æ›´æ–°
  Object.keys(settings).forEach(itemKey => {
    const toggle = document.querySelector(`.toggle-switch[data-item="${itemKey}"]`);
    if (toggle) {
      if (settings[itemKey]) {
        toggle.classList.add('active');
      } else {
        toggle.classList.remove('active');
      }
    }
  });
}

// æŒ‡å®šå¹´æœˆä»¥å‰ã®å…¨è¨˜éŒ²ã‚’å–å¾—
function getRecordsUpToMonth(year, month) {
  const records = [];
  const targetDate = new Date(year, month - 1, 1); // æŒ‡å®šå¹´æœˆã®1æ—¥

  // 2024å¹´1æœˆã‹ã‚‰æŒ‡å®šå¹´æœˆã¾ã§å…¨ã¦ã‚’ãƒã‚§ãƒƒã‚¯
  const startYear = 2024;
  const startMonth = 1;

  for (let y = startYear; y <= year; y++) {
    const monthStart = (y === startYear) ? startMonth : 1;
    const monthEnd = (y === year) ? month : 12;

    for (let m = monthStart; m <= monthEnd; m++) {
      const daysInMonth = new Date(y, m, 0).getDate();

      for (let day = 1; day <= daysInMonth; day++) {
        const key = `training_${y}_${m}_${day}`;
        const data = localStorage.getItem(key);

        // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã€ã‹ã¤ä½•ã‚‰ã‹ã®è¨˜éŒ²ãŒã‚ã‚‹å ´åˆã®ã¿è¿½åŠ 
        if (data) {
          try {
            const parsedData = JSON.parse(data);
            const hasBloodPressure = parsedData.bloodPressure && parsedData.bloodPressure.systolic;
            const hasWeight = parsedData.weight;
            const hasTraining = parsedData.exercises && parsedData.exercises.length > 0;
            
            // ä½•ã‚‰ã‹ã®è¨˜éŒ²ãŒã‚ã‚‹å ´åˆã®ã¿è¿½åŠ 
            if (hasBloodPressure || hasWeight || hasTraining) {
              records.push({
                date: new Date(y, m - 1, day),
                data: parsedData,
                key: key
              });
            }
          } catch (error) {
            console.error(`ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ (${key}):`, error);
          }
        }
      }
    }
  }

  // æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
  return records.sort((a, b) => b.date - a.date);
}

// ã‚‚ã£ã¨è¦‹ã‚‹
function loadMoreRecords() {
  const container = document.getElementById('timeline-container');
  const loadMoreBtn = document.getElementById('btn-load-more');
  
  const start = displayedRecords;
  const end = Math.min(start + recordsPerPage, allRecords.length);

  // ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒ0ä»¶ã®å ´åˆ
  if (allRecords.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ“­</div>
        <div class="empty-title">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
        <div class="empty-description">
          ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”»é¢ã‹ã‚‰æ—¥ã€…ã®è¨˜éŒ²ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†
        </div>
        <a href="calendar.html" class="empty-action">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸</a>
      </div>
    `;
    document.getElementById('load-more-section').classList.add('hidden');
    return;
  }

  // ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºï¼ˆå¹´ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’æŒ¿å…¥ï¼‰
  let lastYear = start > 0 && allRecords[start - 1] 
    ? allRecords[start - 1].date.getFullYear() 
    : null;
  
  for (let i = start; i < end; i++) {
    const record = allRecords[i];
    const currentYearValue = record.date.getFullYear();
    
    // å¹´ãŒå¤‰ã‚ã£ãŸã‚‰ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’æŒ¿å…¥ï¼ˆã¾ãŸã¯æœ€åˆã®ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼‰
    if (lastYear === null || lastYear !== currentYearValue) {
      const separator = createYearSeparator(currentYearValue);
      container.appendChild(separator);
    }
    
    const card = createTimelineCard(record);
    container.appendChild(card);
    
    lastYear = currentYearValue;
  }

  displayedRecords = end;

  // ã™ã¹ã¦è¡¨ç¤ºã—ãŸå ´åˆã¯ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
  if (displayedRecords >= allRecords.length) {
    loadMoreBtn.disabled = true;
    loadMoreBtn.textContent = 'ã™ã¹ã¦è¡¨ç¤ºã—ã¾ã—ãŸ';
  } else {
    loadMoreBtn.disabled = false;
    loadMoreBtn.textContent = `ã‚‚ã£ã¨è¦‹ã‚‹ (æ®‹ã‚Š${allRecords.length - displayedRecords}ä»¶)`;
  }
  
  // ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹å ´åˆ
  if (allRecords.length <= recordsPerPage) {
    document.getElementById('load-more-section').classList.add('hidden');
  } else {
    document.getElementById('load-more-section').classList.remove('hidden');
  }
}

// å¹´ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ä½œæˆ
function createYearSeparator(year) {
  const separator = document.createElement('div');
  separator.className = 'year-separator';
  separator.innerHTML = `
    <div class="line"></div>
    <div class="year-text">${year}å¹´</div>
    <div class="line"></div>
  `;
  return separator;
}

// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ä½œæˆ
function createTimelineCard(record) {
  const card = document.createElement('div');
  
  // è¨˜éŒ²ãŒã‚ã‚‹ã“ã¨ãŒå‰æãªã®ã§ã€recordedã‚¯ãƒ©ã‚¹ã®ã¿ä½¿ç”¨
  card.className = 'timeline-card recorded';

  const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
  const weekday = weekdays[record.date.getDay()];
  const dateStr = `${record.date.getMonth() + 1}æœˆ${record.date.getDate()}æ—¥`;

  // è¡¨ç¤ºè¨­å®šã‚’èª­ã¿è¾¼ã‚€
  const settings = loadDisplaySettings();
  
  // è¡¨ç¤ºè¨­å®šã«å¿œã˜ã¦è¡¨ç¤ºã™ã‚‹é …ç›®ã‚’æ±ºå®š
  let bodyContent = '';
  
  if (settings.bloodPressure) {
    bodyContent += renderBloodPressure(record.data.bloodPressure);
  }
  
  if (settings.weight) {
    bodyContent += renderWeight(record.data.weight, record);
  }
  
  if (settings.exerciseRecord) {
    bodyContent += renderTraining(record.data.exercises, settings);
  }

  card.innerHTML = `
    <div class="card-header">
      <div class="card-date">
        ğŸ—“ ${dateStr}
        <span class="card-weekday">(${weekday})</span>
      </div>
    </div>

    <div class="card-body">
      ${bodyContent}
    </div>
  `;

  return card;
}

// è¡€åœ§è¡¨ç¤º
function renderBloodPressure(bloodPressure) {
  if (!bloodPressure || !bloodPressure.systolic) {
    return `
      <div class="data-section">
        <div class="data-header">ğŸ©º è¡€åœ§</div>
        <div class="empty-message">æœªè¨˜éŒ²</div>
      </div>
    `;
  }

  return `
    <div class="data-section">
      <div class="data-header">ğŸ©º è¡€åœ§</div>
      <div class="data-content">
        <div class="data-row">
          <span class="data-label">æœ€é«˜è¡€åœ§</span>
          <span class="data-value">${bloodPressure.systolic} <span style="font-size: 0.8em; color: #616161;">mmHg</span></span>
        </div>
        <div class="data-row">
          <span class="data-label">æœ€ä½è¡€åœ§</span>
          <span class="data-value">${bloodPressure.diastolic} <span style="font-size: 0.8em; color: #616161;">mmHg</span></span>
        </div>
      </div>
    </div>
  `;
}

// ä½“é‡è¡¨ç¤º
function renderWeight(weight, record) {
  if (!weight) {
    return `
      <div class="data-section">
        <div class="data-header">âš–ï¸ ä½“é‡</div>
        <div class="empty-message">æœªè¨˜éŒ²</div>
      </div>
    `;
  }

  // å‰æ—¥ã¨ã®æ¯”è¼ƒ
  const prevDate = new Date(record.date);
  prevDate.setDate(prevDate.getDate() - 1);
  const prevKey = `training_${prevDate.getFullYear()}_${prevDate.getMonth() + 1}_${prevDate.getDate()}`;
  const prevData = localStorage.getItem(prevKey);
  
  let changeHtml = '';
  if (prevData) {
    try {
      const prev = JSON.parse(prevData);
      if (prev.weight) {
        const change = weight - prev.weight;
        const changeClass = change > 0 ? 'negative' : (change < 0 ? 'positive' : '');
        const changeSymbol = change > 0 ? 'â–²' : (change < 0 ? 'â–¼' : '');
        changeHtml = `<span class="data-change ${changeClass}">(å‰æ—¥æ¯” ${changeSymbol}${Math.abs(change).toFixed(1)}kg)</span>`;
      }
    } catch (error) {
      console.error('å‰æ—¥ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  return `
    <div class="data-section">
      <div class="data-header">âš–ï¸ ä½“é‡</div>
      <div class="data-content">
        <div class="data-row">
          <span class="data-label">ä½“é‡</span>
          <span class="data-value">
            ${weight} <span style="font-size: 0.8em; color: #616161;">kg</span>
            ${changeHtml}
          </span>
        </div>
      </div>
    </div>
  `;
}

// é‹å‹•è¡¨ç¤º
function renderTraining(training, settings) {
  if (!training || training.length === 0) {
    return '';
  }

  let totalTime = 0;
  let totalCalories = 0;

  training.forEach(item => {
    totalTime += item.duration || 0;
    totalCalories += item.calories || 0;
  });

  // ã‚µãƒãƒªãƒ¼éƒ¨åˆ†ã‚’è¡¨ç¤ºè¨­å®šã«å¿œã˜ã¦ä½œæˆ
  let summaryParts = [];
  if (settings.trainingTime) {
    summaryParts.push(`${totalTime}åˆ†`);
  }
  if (settings.calories) {
    summaryParts.push(`${Math.round(totalCalories)}kcal`);
  }
  
  const summaryText = summaryParts.length > 0 ? ` (åˆè¨ˆ: ${summaryParts.join(' / ')})` : '';

  // å„é‹å‹•ã®è©³ç´°ã‚’è¡¨ç¤ºè¨­å®šã«å¿œã˜ã¦ä½œæˆ
  const trainingHtml = training.map(item => {
    let detailsParts = [];
    if (settings.trainingTime) {
      detailsParts.push(`${item.duration}åˆ†`);
    }
    if (settings.calories) {
      detailsParts.push(`${Math.round(item.calories)}kcal`);
    }
    
    const detailsText = detailsParts.join(' / ');

    return `
      <div class="training-item">
        <div class="training-name">${item.icon || 'ğŸƒ'} ${item.name || 'é‹å‹•'}${item.details ? ` - ${item.details}` : ''}</div>
        ${detailsText ? `<div class="training-details">${detailsText}</div>` : ''}
      </div>
    `;
  }).join('');

  return `
    <div class="data-section">
      <div class="data-header">ğŸƒ é‹å‹•${summaryText}</div>
      <div class="training-list">
        ${trainingHtml}
      </div>
    </div>
  `;
}
</script>

</body>
</html>